---
layout: map
---
<nav id='menu-ui' class='menu-ui'></nav>
<div id="map" style="top:0px;left:0px;width:100%;height:100%;"></div>
<script>
    var createLink = function(map, layer, label){
        var link = document.createElement('a');
        link.href = '#';
        link.className = 'active';
        link.innerHTML = label;
        $(link).data('map', map)
        $(link).data('layer', layer)
        $(link).click(function(e){
            e.preventDefault();
            e.stopPropagation();
            var map = $(this).data('map');
            var layer = $(this).data('layer');
            if(map.hasLayer(layer))
            {
                map.removeLayer(layer);
                this.className = ''
            }
            else
            {
                map.addLayer(layer);
                this.className = 'active';
            }
        });
        return link;
    };
    var layerswitcher = document.getElementById('menu-ui');

    var accessToken = 'pk.eyJ1IjoiaGl1IiwiYSI6InJWNGZJSzgifQ.xK1ndT3W8XL9lwVZrT6jvQ';
    var map = L.map('map').setView([0, 30], 3);

    // Imagery Basemap
    //var url_imagery = 'https://api.mapbox.com/v4/hiu.nbk3c19e/{z}/{x}/{y}.png?access_token=' + accessToken;
    // Compositing imagery with LSIB boundaries on the fly.
    var url_basemap = 'https://api.mapbox.com/v4/hiu.nbk3c19e,hiu.lp5bfbt9/{z}/{x}/{y}.png?access_token=' + accessToken
    L.tileLayer(url_basemap, {
      attribution: ''
    }).addTo(map);

    /* LSIB Boundaries
    var url_boundaries = 'http://geonode.state.gov/geoserver/gwc/service/tms/1.0.0/geonode%3AGlobal_LSIB_Lines_Simplified_2015Jan23_USG@EPSG%3A900913@png/{z}/{x}/{y}.png';
    L.tileLayer(url_boundaries, {
      tms: true,
      attribution: 'Names and boundary representation are not necessarily authoritative.'
    }).addTo(map);
    */

    // LSIB Countries UTFGrid
    var countries = new L.UtfGrid(
        'http://{s}.tiles.mapbox.com/v4/hiu.lp5bfbt9/{z}/{x}/{y}.grid.json?access_token='+ accessToken,
    {
        resolution: 2,
        useJsonP: false
    });
    countries.on('click', function (e) {
        if (e.data) {
            alert('click: ' + e.data.CNTRY_NAME);
        } else {
            alert('click: nothing');
        }
    });
    countries.addTo(map);
    // Products GeoJSON
    var productIcon = L.icon({
        iconUrl: "{{ site.baseurl }}/assets/img/icon_product.svg",
        iconSize: [30, 45],
        iconAnchor: [15, 40],
        popupAnchor: [0, 0]
    });
    $.ajax({
        dataType: "json",
        url: "{{ site.baseurl}}/products/products.json",
        success: function(response) {
            var products = L.geoJson(response, {
                onEachFeature: function(feature, layer) {
                    var popupOptions = {maxWidth: 200};
                    //layer.setIcon(productIcon);
                    var popupContent = '<h4><a href="'+feature.properties.url+'">'+feature.properties.title+"</a></h4><br>Date Published: "+feature.properties.date_published+'<br>Region: <a href="{{ site.baseurl }}/regions/'+feature.properties.region_id+'">'+feature.properties.region_title+'</a><br><a href="'+feature.properties.pdf+'">Download</a>';
                    layer.bindPopup(popupContent, popupOptions);
                }
            });
            products.addTo(map);
            layerswitcher.appendChild(createLink(map, products, 'Products'));
        }
    });
    var buildBoundingBox = function(b)
    {
        var g = [0,0,0,0];
        try{
            g =
            [
                parseFloat(parseFloat(b.children('westBoundLongitude').text()).toFixed(4)),
                parseFloat(parseFloat(b.children('southBoundLatitude').text()).toFixed(4)),
                parseFloat(parseFloat(b.children('eastBoundLongitude').text()).toFixed(4)),
                parseFloat(parseFloat(b.children('northBoundLatitude').text()).toFixed(4))
            ];
        }catch(err){g = [0,0,0,0];}
        return g;
    };
    var ellipsis = function(text,len)
    {
        if(len==-1)
            return text;
        else
            return (text.length>len)?(text.substring(0,len-3)+'...'):text;
    };
    // Data GeoJSON
    $.ajax({
        dataType: "xml",
        url: "{{ site.geonode_wms }}",
        success: function(response) {
            console.log("Response:", response);
            var geonode_features = [];
            var geonode_layers = $(response).find('Layer').each(function(){
                var b = $(this).children('EX_GeographicBoundingBox:first');
                if(b.length > 0)
                {
                    var g = buildBoundingBox(b);
                    var f =
                    {
                        "type": "Feature",
                        "properties":
                        {
                            "name": $(this).children('Name').text(),
                            "title": $(this).children('Title').text(),
                            "abstract": ellipsis($(this).children('Abstract').text().replace('\n',''), 100)
                        },
                        "geometry":
                        {
                            "type": "Polygon",
                            "coordinates":
                            [
                              [
                                  [g[0], g[1]],
                                  [g[2], g[1]],
                                  [g[2], g[3]],
                                  [g[0], g[3]]
                              ]
                            ]                        
                        }
                    };
                    geonode_features.push(f);
                }
            });
            var geonode_geojson =
            {
                "type": "FeatureCollection",
                "features": geonode_features
            };
            var geonode_style = {
               "color": "#0000FF",
               "fillOpacity": 0,
               "strokeOpacity": 1.0
            };
            var datasets = L.geoJson(geonode_geojson, {
                style: geonode_style,
                onEachFeature: function(feature, layer) {
                    var popupOptions = {maxWidth: 200};
                    //layer.setIcon(productIcon);
                    var popupContent = '<h4 style="word-wrap:break-word;"><a href="{{ site.geonode_layers }}/'+feature.properties.name+'">'+feature.properties.title+"</a></h4><hr>Abstract<br>"+feature.properties.abstract;
                    layer.bindPopup(popupContent, popupOptions);
                }
            });
            datasets.addTo(map);
            layerswitcher.appendChild(createLink(map, datasets, 'Datasets'));
        }
    });
    $.ajax({
        dataType: "json",
        url: "{{ site.baseurl}}/events/events.json",
        success: function(response) {
            var events = L.geoJson(response, {
                onEachFeature: function(feature, layer) {
                    var popupOptions = {maxWidth: 200};
                    //layer.setIcon(productIcon);
                    var popupContent = '<h4><a href="'+feature.properties.url+'">'+feature.properties.title+'</a></h4>';
                    layer.bindPopup(popupContent, popupOptions);
                }
            });
            events.addTo(map);
            layerswitcher.appendChild(createLink(map, events, 'Events'));
        }
    });
</script>
