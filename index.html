---
layout: map
---
<div id="map" style="top:0px;left:0px;width:100%;height:100%;"></div>
<script>
    var accessToken = 'pk.eyJ1IjoiaGl1IiwiYSI6InJWNGZJSzgifQ.xK1ndT3W8XL9lwVZrT6jvQ';
    var map = L.map('map').setView([0, 30], 3);

    // Imagery Basemap
    var url_imagery = 'https://api.mapbox.com/v4/hiu.nbk3c19e/{z}/{x}/{y}.png?access_token=' + accessToken;
    //var tileUrl = 'https://api.mapbox.com/v4/hiu.nbk3c19e,hiu.lsib-dark/{z}/{x}/{y}.png?access_token=' + accessToken
    L.tileLayer(url_imagery, {
      attribution: ''
    }).addTo(map);

    // LSIB Boundaries
    var url_boundaries = 'http://geonode.state.gov/geoserver/gwc/service/tms/1.0.0/geonode%3AGlobal_LSIB_Lines_Simplified_2015Jan23_USG@EPSG%3A900913@png/{z}/{x}/{y}.png';
    L.tileLayer(url_boundaries, {
      tms: true,
      attribution: 'Names and boundary representation are not necessarily authoritative.'
    }).addTo(map);

    // Products GeoJSON
    var productIcon = L.icon({
        iconUrl: "{{ site.baseurl }}/assets/img/icon_product.svg",
        iconSize: [30, 45],
        iconAnchor: [15, 40],
        popupAnchor: [0, 0]
    });
    $.ajax({
        dataType: "json",
        url: "{{ site.baseurl}}/products/products.json",
        success: function(response) {
            var products = L.geoJson(response, {
                onEachFeature: function(feature, layer) {
                    var popupOptions = {maxWidth: 200};
                    //layer.setIcon(productIcon);
                    var popupContent = '<h4><a href="'+feature.properties.url+'">'+feature.properties.title+"</a></h4><br>Date Published: "+feature.properties.date_published+'<br>Region: <a href="{{ site.baseurl }}/regions/'+feature.properties.region_id+'">'+feature.properties.region_title+'</a><br><a href="'+feature.properties.pdf+'">Download</a>';
                    layer.bindPopup(popupContent, popupOptions);
                }
            });
            products.addTo(map);
        }
    });
    var buildBoundingBox = function(b)
    {
        var g = [0,0,0,0];
        try{
            g =
            [
                parseFloat(parseFloat(b.children('westBoundLongitude').text()).toFixed(4)),
                parseFloat(parseFloat(b.children('southBoundLatitude').text()).toFixed(4)),
                parseFloat(parseFloat(b.children('eastBoundLongitude').text()).toFixed(4)),
                parseFloat(parseFloat(b.children('northBoundLatitude').text()).toFixed(4))
            ];
        }catch(err){g = [0,0,0,0];}
        return g;
    };
    // Data GeoJSON
    $.ajax({
        dataType: "xml",
        url: "{{ site.geonode_wms }}",
        success: function(response) {
            console.log("Response:", response);
            var geonode_features = [];
            var geonode_layers = $(response).find('Layer').each(function(){
                var b = $(this).children('EX_GeographicBoundingBox:first');
                if(b.length > 0)
                {
                    var g = buildBoundingBox(b);
                    var f =
                    {
                        "type": "Feature",
                        "properties":
                        {
                            "name": $(this).children('Name').text(),
                            "title": $(this).children('Title').text(),
                            "abstract": $(this).children('Abstract').text().replace('\n','')
                        },
                        "geometry":
                        {
                            "type": "Polygon",
                            "coordinates":
                            [
                              [
                                  [g[0], g[1]],
                                  [g[2], g[1]],
                                  [g[2], g[3]],
                                  [g[0], g[3]]
                              ]
                            ]                        
                        }
                    };
                    geonode_features.push(f);
                }
            });
            var geonode_geojson =
            {
                "type": "FeatureCollection",
                "features": geonode_features
            };
            var datasets = L.geoJson(geonode_geojson, {
                onEachFeature: function(feature, layer) {
                    var popupOptions = {maxWidth: 200};
                    //layer.setIcon(productIcon);
                    var popupContent = '<h4><a href="{{ site.geonode_layers }}/'+feature.properties.name+'">'+feature.properties.title+"</a></h4><hr>Abstract<br>"+feature.properties.abstract;
                    layer.bindPopup(popupContent, popupOptions);
                }
            });
            datasets.addTo(map);
        }
    });

</script>
